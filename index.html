<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bases Loaded — Player Stats Integrated</title>
<style>
  :root{
    --bg:#061026; --card:#0d2436; --muted:#88a6bf; --accent:#34c3ff; --good:#4caf50; --warn:#ffd166;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,#031022 0%,#071528 100%);color:#e7f1fb}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:18px;max-width:1200px;margin:0 auto}
  .brand{display:flex;gap:12px;align-items:center}
  .brand img{height:44px;border-radius:6px}
  h1{margin:0;font-size:20px}
  .topline{color:var(--muted);font-size:13px}
  .container{max-width:1200px;margin:18px auto;padding:0 14px}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .small{font-size:13px;color:var(--muted)}
  .games{display:flex;flex-direction:column;gap:12px}
  .game{display:flex;flex-direction:column;gap:10px;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
  .title{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .teams{display:flex;gap:12px;align-items:center}
  .team{display:flex;flex-direction:column;align-items:center;gap:6px}
  .team .name{font-weight:800}
  .meta{color:var(--muted);font-size:13px}
  .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .stat{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;text-align:center}
  .why{background:rgba(255,201,102,0.06);padding:10px;border-radius:8px;color:var(--warn);font-weight:700}
  .controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  input,select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  button{background:var(--accent);color:#021023;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
  .muted{color:var(--muted)}
  #apiCounters{display:flex;gap:12px;align-items:center}
  .pill{background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:999px;font-weight:700}
  footer{max-width:1200px;margin:18px auto;padding:12px 14px;color:var(--muted);font-size:13px}
  .player-list{display:flex;flex-direction:column;gap:6px;margin-top:6px}
  .player-item{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
  @media(max-width:980px){.grid{grid-template-columns:1fr}header,.container,footer{padding:0 12px}}
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="https://upload.wikimedia.org/wikipedia/en/0/0b/MLB_logo.svg" alt="MLB">
    <div>
      <h1>Bases Loaded — Player Stats Live</h1>
      <div class="topline">OddsAPI + BallDontLie (MLB) — PH Time (UTC+8). Mock backup included.</div>
    </div>
  </div>

  <div id="apiCounters">
    <div class="pill">OddsAPI left: <span id="oddsLeft">500</span></div>
    <div class="pill">BDL cached calls: <span id="bdlCount">0</span></div>
  </div>
</header>

<div class="container">
  <div class="grid">
    <!-- LEFT -->
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Dashboard</div>
            <h2 style="margin:6px 0">Today's games & player stats</h2>
            <div class="small muted">Auto-updates from OddsAPI + BallDontLie — cached to save your quota</div>
          </div>
          <div class="small muted">Local (PH): <span id="localPH">--:--</span></div>
        </div>

        <hr style="border:none;height:8px">

        <div class="games" id="gamesList">
          <!-- Cards injected here -->
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="card">
        <h3>Bet & EV Calculator</h3>
        <div class="small muted">Pick a team shown above (dropdown auto-filled)</div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <input id="stakeInput" type="number" placeholder="Stake (PHP)" min="1" style="width:140px">
          <select id="betTeamSelect" style="min-width:220px">
            <option value="">Select team...</option>
          </select>
          <button id="calcBtn">Calculate</button>
        </div>
        <div id="calcResult" style="margin-top:12px" class="muted"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <aside>
      <div class="card">
        <h3>Quick Controls</h3>
        <div class="small muted">Filters, refresh and snapshot</div>
        <div style="margin-top:8px" class="controls">
          <select id="filterSelect"><option value="all">All games</option><option value="value">Value (EV>0)</option></select>
          <select id="sortSelect"><option value="time">Time (PH)</option><option value="ev">EV desc</option></select>
          <button id="refreshBtn">Refresh</button>
          <button id="saveBtn" style="background:#4caf50">Save snapshot</button>
        </div>
        <div style="margin-top:10px" class="small muted">Saved: <span id="savedAt">—</span></div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h3>Recommended Teams</h3>
        <ul id="recommendedList" class="small muted" style="margin:8px 0;padding-left:18px"></ul>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <h3>News (Mock)</h3>
        <div id="newsList" class="small muted">Lineups and injuries will appear here.</div>
      </div>
    </aside>
  </div>
</div>

<footer>
  <div>© 2025 Bases Loaded — Prototype. Keys are client-side for demo. Move to server/proxy for production.</div>
</footer>

<script>
/* ============================
   CONFIG - use keys you gave
   ============================ */
const ODDS_API_KEY = "6d667177117b78ce8b2c728ee4721cb9"; // provided earlier
const BDL_API_KEY   = "03b94385-b4ec-4575-9bb8-1f5954410c64"; // provided earlier
const ODDS_API_URL  = "https://api.the-odds-api.com/v4/sports/baseball_mlb/odds/";
const BDL_BASE      = "https://mlb.balldontlie.io/api/v1"; // try MLB-specific host; fallback inside functions

/* ============================
   STATE + CACHE
   ============================ */
const STATE = {
  oddsLeft: 500,
  bdlCalls: 0,
  cacheTTL: 1000 * 60 * 30, // 30 min
  cache: {}
};
function saveCache(){ sessionStorage.setItem('bl_cache', JSON.stringify({ts:Date.now(),data:STATE.cache})); }
function loadCache(){
  try{
    const raw = sessionStorage.getItem('bl_cache'); if(!raw) return;
    const obj = JSON.parse(raw);
    if(Date.now()-obj.ts > STATE.cacheTTL){ sessionStorage.removeItem('bl_cache'); return; }
    STATE.cache = obj.data || {};
  }catch(e){}
}
function getCached(k){ loadCache(); const r = STATE.cache[k]; if(!r) return null; if(Date.now()-r.ts>STATE.cacheTTL){ delete STATE.cache[k]; saveCache(); return null;} return r.value; }
function setCached(k,v){ STATE.cache[k] = {ts:Date.now(), value:v}; saveCache(); }

/* ============================
   UTIL
   ============================ */
const qs = id => document.getElementById(id);
function nowPH(){ const now = new Date(); const utc = new Date(now.getTime() + now.getTimezoneOffset()*60000); const ph = new Date(utc.getTime() + 8*3600000); return ph.toLocaleString('en-PH',{hour:'2-digit',minute:'2-digit',month:'short',day:'numeric'}); }
function toPH(iso){ try{ const d=new Date(iso); const ph=new Date(d.getTime()+8*3600000); return ph.toLocaleString('en-PH',{weekday:'short',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});}catch(e){return iso;} }
function normalizeName(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim(); }
function impliedProb(o){ if(!o||o<=0) return 0; return (1/o)*100; }

/* ============================
   MOCK fallback data (keeps UI rich)
   ============================ */
const MOCK_GAMES = [
  { id:"m1", home:"New York Yankees", away:"Boston Red Sox", commence_time:"2025-09-27T18:30:00Z", stadium:"Yankee Stadium", pitcherHome:"G. Cole", pitcherAway:"C. Sale", battersHome:["Judge","Rizzo","LeMahieu"], battersAway:["Devers","Verdugo","Bogaerts"], last10Home:{wins:8,losses:2}, last10Away:{wins:5,losses:5}, odds:{home:1.90, away:2.10} },
  { id:"m2", home:"Los Angeles Dodgers", away:"San Francisco Giants", commence_time:"2025-09-27T20:10:00Z", stadium:"Dodger Stadium", pitcherHome:"W. Buehler", pitcherAway:"L. Webb", battersHome:["Betts","Seager","Muncy"], battersAway:["Belt","La Stella","Yastrzemski"], last10Home:{wins:7,losses:3}, last10Away:{wins:6,losses:4}, odds:{home:1.65, away:2.30} }
];

/* ============================
   BALLDONTLIE (MLB) helpers
   - Tries multiple endpoints & includes API key where possible.
   - Caches results.
   ============================ */
async function bdlFetch(path, params = {}){
  // Build URL with query params and api_key
  try{
    const url = new URL((BDL_BASE + path));
    // append params
    Object.keys(params || {}).forEach(k => url.searchParams.set(k, params[k]));
    // include key as query if provided (best-effort)
    if(BDL_API_KEY) url.searchParams.set('api_key', BDL_API_KEY);
    const headers = {};
    if(BDL_API_KEY) headers['Authorization'] = `Bearer ${BDL_API_KEY}`;
    const res = await fetch(url.toString(), { headers });
    STATE.bdlCalls++; qs('bdlCount').textContent = STATE.bdlCalls;
    if(!res.ok) throw new Error('bdl fetch failed '+res.status);
    const j = await res.json();
    return j;
  }catch(err){
    console.warn('bdlFetch error',err);
    return null;
  }
}

async function fetchBdlTeams(){
  const k='bdl_teams_v1';
  const cached = getCached(k); if(cached) return cached;
  // try mlb.balldontlie first, fallback to other host
  const resp = await bdlFetch('/teams');
  if(resp && (resp.data||resp.length)) { setCached(k, resp.data || resp); return resp.data || resp; }
  return null;
}

async function fetchTopBattersForTeam(teamId, perPage = 6){
  const k = `bdl_topbatters_${teamId}_${perPage}`;
  const cached = getCached(k); if(cached) return cached;
  // try season_stats endpoint (common)
  const resp = await bdlFetch('/season_stats', { team_ids: teamId, per_page: perPage, sort:'-hits' });
  if(resp && (resp.data || resp.length)) { const arr = resp.data || resp; setCached(k, arr); return arr; }
  // fallback: try players endpoint and filter (less ideal)
  const resp2 = await bdlFetch('/players', { team_ids: teamId, per_page: perPage });
  if(resp2 && (resp2.data||resp2.length)) { setCached(k, resp2.data || resp2); return resp2.data || resp2; }
  return null;
}

async function fetchLastGamesForTeam(teamId, limit = 10){
  const k=`bdl_games_${teamId}_${limit}`;
  const cached = getCached(k); if(cached) return cached;
  const resp = await bdlFetch('/games', { team_ids: teamId, per_page: limit });
  if(resp && (resp.data || resp.length)){ setCached(k, resp.data || resp); return resp.data || resp; }
  return null;
}

/* ============================
   ODDSAPI wrapper
   ============================ */
async function fetchOddsAPI(){
  const k='odds_v1';
  const cached = getCached(k); if(cached) return cached;
  if(STATE.oddsLeft <= 0) return null;
  try{
    const url = new URL(ODDS_API_URL);
    url.searchParams.set('apiKey', ODDS_API_KEY);
    url.searchParams.set('regions','us');
    url.searchParams.set('markets','h2h');
    url.searchParams.set('oddsFormat','decimal');
    const res = await fetch(url.toString());
    STATE.oddsLeft = Math.max(0, (STATE.oddsLeft || 500) - 1);
    qs('oddsLeft').textContent = STATE.oddsLeft;
    if(!res.ok) throw new Error('odds failed '+res.status);
    const data = await res.json();
    setCached(k,data);
    return data;
  }catch(err){
    console.warn('fetchOddsAPI err',err);
    return null;
  }
}

/* ============================
   Mapping / enrichment
   ============================ */
function findTeamIdByName(oddsName, teamsList){
  if(!teamsList||!teamsList.length) return null;
  const n = normalizeName(oddsName);
  // try direct matching on full_name or abbreviation or name
  for(const t of teamsList){
    if(t.full_name && normalizeName(t.full_name) === n) return t.id;
    if(t.abbreviation && normalizeName(t.abbreviation) === n) return t.id;
    if(t.name && normalizeName(t.name) === n) return t.id;
  }
  // substring heuristics
  for(const t of teamsList){
    if(t.full_name && normalizeName(t.full_name).includes(n)) return t.id;
    if(n.includes(normalizeName(t.full_name).split(' ')[0])) return t.id;
  }
  return null;
}

/* ============================
   Heuristic: compute why & recommended
   ============================ */
function computeWhy(game){
  const lastHome = game.last10Home || {wins:5,losses:5};
  const lastAway = game.last10Away || {wins:5,losses:5};
  const homePct = (lastHome.wins / (lastHome.wins + lastHome.losses)) * 100;
  const awayPct = (lastAway.wins / (lastAway.wins + lastAway.losses)) * 100;
  const ipcHome = impliedProb(game.odds.home || 1);
  const ipcAway = impliedProb(game.odds.away || 1);
  const homeScore = (homePct * 0.6) + ((100 - ipcHome) * 0.4);
  const awayScore = (awayPct * 0.6) + ((100 - ipcAway) * 0.4);
  const diff = (homeScore - awayScore);
  let verdict = 'Even';
  if(Math.abs(diff) >= 12) verdict = 'Strong';
  else if(Math.abs(diff) >= 6) verdict = 'Lean';
  const recommended = homeScore >= awayScore ? game.home : game.away;
  const explanation = `${recommended} • ${verdict} edge — Last10 H:${homePct.toFixed(0)}% A:${awayPct.toFixed(0)}% • IPC H:${ipcHome.toFixed(1)}% A:${ipcAway.toFixed(1)}%`;
  return { recommended, verdict, explanation, homeScore, awayScore };
}

/* ============================
   Render UI
   ============================ */
function renderGamesList(games){
  const el = qs('gamesList');
  el.innerHTML = '';
  STATE.displayedGames = games;
  const betSel = qs('betTeamSelect');
  betSel.innerHTML = '<option value="">Select team...</option>';

  for(const g of games){
    const why = computeWhy(g);
    const card = document.createElement('div'); card.className = 'game';
    card.innerHTML = `
      <div class="title">
        <div class="teams">
          <div class="team"><div class="name">${g.away}</div><div class="meta">Away</div></div>
          <div class="team"><div class="name">${g.home}</div><div class="meta">Home</div></div>
        </div>
        <div style="text-align:right">
          <div class="meta">${toPH(g.commence_time)}</div>
          <div class="meta">Stadium: ${g.stadium || '—'}</div>
        </div>
      </div>

      <div class="stats-grid" style="margin-top:10px">
        <div class="stat"><div class="small muted">Home Pitcher</div><div>${g.pitcherHome || 'TBD'}</div></div>
        <div class="stat"><div class="small muted">Away Pitcher</div><div>${g.pitcherAway || 'TBD'}</div></div>
        <div class="stat"><div class="small muted">Recommended</div><div>${why.recommended} <span style="color:${why.verdict==='Strong'? '--good' : why.verdict==='Lean' ? 'var(--warn)' : 'var(--muted)'}">(${why.verdict})</span></div></div>

        <div class="stat"><div class="small muted">Home last10</div><div>${(g.last10Home?.wins ?? '—')}W - ${(g.last10Home?.losses ?? '—')}L</div></div>
        <div class="stat"><div class="small muted">Away last10</div><div>${(g.last10Away?.wins ?? '—')}W - ${(g.last10Away?.losses ?? '—')}L</div></div>
        <div class="stat"><div class="small muted">EV diff</div><div>${( (why.homeScore||0) - (why.awayScore||0) ).toFixed(1)} pts</div></div>

        <div class="stat"><div class="small muted">Odds H</div><div>${g.odds.home || '—'}</div></div>
        <div class="stat"><div class="small muted">Odds A</div><div>${g.odds.away || '—'}</div></div>
        <div class="stat"><div class="small muted">Top Batters (H)</div><div>${(g.battersHome||[]).slice(0,4).map(b=>b.name||b).join(', ') || '—'}</div></div>
      </div>

      <div style="margin-top:10px" class="why">${why.explanation}</div>

      <div style="margin-top:10px">
        <div class="small muted">Top batters (home)</div>
        <div class="player-list" id="players_${encodeURIComponent(g.id)}">
          <!-- players inserted here -->
        </div>
      </div>
    `;
    el.appendChild(card);

    // populate bet dropdown
    [g.home, g.away].forEach(t=>{
      if(![...betSel.options].some(o=>o.value===t)){
        const o = document.createElement('option'); o.value=t; o.textContent=t; betSel.appendChild(o);
      }
    });
    // populate players list (if batters info available)
    const playersWrap = card.querySelector(`#players_${encodeURIComponent(g.id)}`);
    if(g.battersHome && g.battersHome.length){
      for(const p of g.battersHome.slice(0,4)){
        const div = document.createElement('div'); div.className='player-item';
        div.innerHTML = `<div>${p.name||p}</div><div class="small muted">${p.statSummary || ''}</div>`;
        playersWrap.appendChild(div);
      }
    } else {
      playersWrap.innerHTML = '<div class="small muted">Top batters not available</div>';
    }
  }
}

/* ============================
   Build & enrich pipeline
   ============================ */
async function buildAndRender(){
  qs('localPH').textContent = nowPH();
  // 1) fetch teams
  const teamsList = await fetchBdlTeams() || [];
  // 2) fetch odds
  const oddsPayload = await fetchOddsAPI();
  let normalized = [];
  if(Array.isArray(oddsPayload) && oddsPayload.length){
    normalized = oddsPayload.map(normalizeOddsGame);
  } else {
    normalized = MOCK_GAMES.map(m => ({
      id: m.id,
      home: m.home,
      away: m.away,
      commence_time: m.commence_time,
      odds: m.odds,
      stadium: m.stadium,
      pitcherHome: m.pitcherHome,
      pitcherAway: m.pitcherAway,
      battersHome: m.battersHome.map(n=>({name:n})),
      battersAway: m.battersAway.map(n=>({name:n})),
      last10Home: m.last10Home,
      last10Away: m.last10Away
    }));
  }

  // Enrich each game using BallDontLie where possible
  for(const g of normalized){
    try{
      // map team to id
      const homeId = findTeamIdByName(g.home, teamsList || []);
      const awayId = findTeamIdByName(g.away, teamsList || []);
      // fetch last10 games if missing
      if(!g.last10Home && homeId){
        const games = await fetchLastGamesForTeam(homeId, 10);
        if(games && games.length){
          const wl = games.slice(0,10).reduce((acc,gm) => {
            // gm.home_team and visitor_team objects contain ids & full_name; use scores
            const hs = gm.home_team_score, vs = gm.visitor_team_score;
            if(hs==null || vs==null) return acc;
            const isHome = normalizeName(g.home) === normalizeName(gm.home_team.full_name || gm.home_team.name || '');
            const didHomeWin = hs > vs;
            if(isHome){
              if(didHomeWin) acc.wins++; else acc.losses++;
            } else {
              // if team was away in that record
              if(!didHomeWin) acc.wins++; else acc.losses++;
            }
            return acc;
          }, {wins:0,losses:0});
          if(wl.wins+wl.losses > 0) g.last10Home = wl;
        }
      }
      if(!g.last10Away && awayId){
        const games = await fetchLastGamesForTeam(awayId,10);
        if(games && games.length){
          const wl = games.slice(0,10).reduce((acc,gm) => {
            const hs = gm.home_team_score, vs = gm.visitor_team_score;
            if(hs==null || vs==null) return acc;
            const isAway = normalizeName(g.away) === normalizeName(gm.visitor_team.full_name || gm.visitor_team.name || '');
            const didAwayWin = vs > hs;
            if(isAway){
              if(didAwayWin) acc.wins++; else acc.losses++;
            } else {
              if(!didAwayWin) acc.wins++; else acc.losses++;
            }
            return acc;
          }, {wins:0,losses:0});
          if(wl.wins+wl.losses > 0) g.last10Away = wl;
        }
      }
      // fetch top batters
      if(homeId){
        const topHome = await fetchTopBattersForTeam(homeId,6);
        if(topHome && topHome.length){
          // map to simple objects: name & statSummary (best-effort)
          g.battersHome = topHome.map(p => {
            // season_stats entries might have player object + stats
            if(p.player){ // if it's a season_stats object
              return { name: p.player.full_name || p.player.name || (p.player.first_name + ' ' + p.player.last_name), statSummary: `HR:${p.home_runs ?? p.hr ?? p.hr_total ?? ''} AVG:${p.avg ?? p.batting_average ?? ''}` };
            } else if(p.full_name){
              return { name: p.full_name, statSummary: ''};
            } else {
              return { name: p.player_name || p.name || p.last_name || 'N/A', statSummary: ''};
            }
          });
        }
      }
      if(awayId){
        const topAway = await fetchTopBattersForTeam(awayId,6);
        if(topAway && topAway.length){
          g.battersAway = topAway.map(p => {
            if(p.player) return { name: p.player.full_name || p.player.name, statSummary: `HR:${p.home_runs ?? ''} AVG:${p.avg ?? ''}` };
            if(p.full_name) return { name: p.full_name, statSummary: '' };
            return { name: p.player_name || p.name, statSummary: '' };
          });
        }
      }
      // stadium: try from teamsList if present
      if(!g.stadium && teamsList && teamsList.length && homeId){
        const ht = teamsList.find(t=>t.id===homeId);
        if(ht && (ht.venue || ht.home_acronym || ht.full_name)) g.stadium = ht.venue || ht.full_name;
      }
    }catch(e){
      console.warn('enrich error',e);
    }
  }

  // normalize/dedupe & sort by time
  const seen = new Set();
  const uniq = normalized.filter(g => {
    const key = `${g.home}|${g.away}|${g.commence_time}`;
    if(seen.has(key)) return false;
    seen.add(key);
    return true;
  }).sort((a,b) => new Date(a.commence_time) - new Date(b.commence_time));

  // ensure defaults
  uniq.forEach(g=>{
    if(!g.last10Home) g.last10Home = {wins:5,losses:5};
    if(!g.last10Away) g.last10Away = {wins:5,losses:5};
    if(!g.odds) g.odds = {home:1.0,away:1.0};
    if(!g.id) g.id = `${g.home}_${g.away}_${g.commence_time}`;
  });

  // store for calculator & UI
  STATE.displayedGames = uniq;
  renderGamesList(uniq);
  // recommended list (≥70% home/away heuristic)
  const recList = qs('recommendedList'); recList.innerHTML='';
  uniq.forEach(g=>{
    const w = computeWhy(g);
    const margin = Math.abs(w.homeScore - w.awayScore);
    if(margin >= 12){
      const li = document.createElement('li'); li.textContent = `${w.recommended} — ${w.explanation}`; recList.appendChild(li);
    }
  });
}

/* ============================
   Simple normalize for OddsAPI game object
   ============================ */
function normalizeOddsGame(obj){
  const outcomes = (obj.bookmakers && obj.bookmakers[0] && obj.bookmakers[0].markets && obj.bookmakers[0].markets[0] && obj.bookmakers[0].markets[0].outcomes) || [];
  let homeP = null, awayP = null;
  outcomes.forEach(o=>{
    if(o.name && obj.home_team && (normalizeName(o.name) === normalizeName(obj.home_team))) homeP = o.price;
    if(o.name && obj.away_team && (normalizeName(o.name) === normalizeName(obj.away_team))) awayP = o.price;
  });
  // fallback: use first two if present
  if(homeP==null && outcomes[0]) homeP = outcomes[0].price;
  if(awayP==null && outcomes[1]) awayP = outcomes[1].price;
  return { id: obj.id || `${obj.home_team}_${obj.away_team}_${obj.commence_time}`, home: obj.home_team, away: obj.away_team, commence_time: obj.commence_time, odds: { home: homeP || 0, away: awayP || 0 }, siteRaw: obj };
}

/* ============================
   Calculator (UI binding)
   ============================ */
qs('calcBtn').addEventListener('click', ()=>{
  const stake = parseFloat(qs('stakeInput').value);
  const team = qs('betTeamSelect').value;
  if(!stake || !team){ alert('Enter stake and pick a team'); return; }
  const g = (STATE.displayedGames || []).find(x => x.home === team || x.away === team);
  if(!g){ alert('Team not in shown games'); return; }
  const odds = (g.home === team) ? (g.odds.home || 1) : (g.odds.away || 1);
  const payout = stake * odds;
  const ipc = impliedProb(odds)/100;
  const ev = (ipc * odds) - 1;
  qs('calcResult').innerHTML = `<div style="font-weight:800">${team}</div>
    <div class="small muted">Odds: ${odds}</div>
    <div style="margin-top:6px">Payout (incl. stake): <strong>₱${payout.toFixed(2)}</strong></div>
    <div>Estimated EV: <strong>${(ev*100).toFixed(2)}%</strong></div>`;
});

/* ============================
   UI wiring: refresh/save
   ============================ */
qs('refreshBtn').addEventListener('click', ()=> buildAndRender());
qs('saveBtn').addEventListener('click', ()=>{
  const snap = { ts: Date.now(), games: STATE.displayedGames };
  localStorage.setItem('bl_snapshot', JSON.stringify(snap));
  qs('savedAt').textContent = new Date(snap.ts).toLocaleString();
});
function loadSnapshot(){ const raw = localStorage.getItem('bl_snapshot'); if(raw) qs('savedAt').textContent = new Date(JSON.parse(raw).ts).toLocaleString(); }

/* ============================
   Small helpers: load news & PH refresh
   ============================ */
function loadMockNews(){ const n = ["Lineups posted — check probable pitchers 4–8 hr before game", "Mock: Closer day-to-day for Team X", "High EV props spotted (mock)"]; qs('newsList').textContent = n.join(' • '); }
function refreshLocalTime(){ qs('localPH').textContent = nowPH(); setTimeout(refreshLocalTime,30000); }

/* ============================
   INIT
   ============================ */
(async function init(){
  loadCache();
  loadMockNews();
  refreshLocalTime();
  loadSnapshot();
  // initial counters
  qs('oddsLeft').textContent = STATE.oddsLeft;
  qs('bdlCount').textContent = STATE.bdlCalls;
  // build UI
  await buildAndRender();
})();
</script>
</body>
</html>
