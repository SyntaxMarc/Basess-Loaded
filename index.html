<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bases Loaded - MLB Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background: #0b1d2f; color: #fff; margin:0; padding:0;}
  header { padding: 20px; text-align: center; background: #071625; }
  header h1 { margin:0; color:#ffce00; }
  .game-card { background: #112a44; border-radius: 10px; margin: 15px auto; padding: 15px; width: 90%; max-width: 900px; box-shadow: 0 0 10px #000; }
  .game-card h2 { margin: 0 0 10px 0; color: #ffce00; }
  .stats, .props { display: flex; flex-wrap: wrap; gap: 10px; margin-top:10px; }
  .stat-item { flex:1; background:#0f1f36; padding:10px; border-radius:5px; text-align:center; font-size: 0.9em; }
  .prob { color: #4CAF50; font-weight: bold; margin-left: 5px; } 
  .highlight { color:#ff9f1c; font-weight:bold; }
  #apiUsage { padding:10px; background:#071625; text-align:center; }
  #calculator { background:#112a44; margin:20px auto; padding:20px; border-radius:10px; max-width:500px; }
  #calculator input, #calculator select, #calculator button { margin:5px 0; padding:8px; width:100%; border-radius:5px; border:none; }
  #calculator button { background:#ffce00; color:#000; font-weight:bold; cursor:pointer; }
  #calcResult { margin-top:10px; background:#0f1f36; padding:10px; border-radius:5px; text-align:center; }
</style>
</head>
<body>
<header>
  <h1>Bases Loaded - MLB Dashboard</h1>
</header>

<div id="apiUsage">OddsAPI Requests Left: <span id="apiCount">500</span></div>

<div id="gamesContainer"></div>

<div id="calculator">
  <h2>Bet & EV Calculator</h2>
  <input type="number" id="stake" placeholder="Enter stake amount" min="1">
  <select id="teamSelect">
    <option value="">Select team</option>
  </select>
  <button onclick="calculateBet()">Calculate</button>
  <div id="calcResult"></div>
</div>

<footer style="padding:15px; text-align:center; background:#071625; margin-top:20px;">
  <small>&copy; 2025 Bases Loaded. All rights reserved.</small>
</footer>

<script>
// --- API & Utility Settings ---
// NOTE: Use your actual OddsAPI key here
const oddsApiKey = '6d667177117b78ce8b2c728ee4721cb9'; 
let apiRemaining = 500; // starting count

const gamesContainer = document.getElementById('gamesContainer');
const teamSelect = document.getElementById('teamSelect');

// --- UTILITY FUNCTION: IMPLIEID PROBABILITY ---
function calculateImpliedProbability(odds) {
    const numOdds = parseFloat(odds);
    if (isNaN(numOdds) || numOdds <= 1) return 0;
    return (1 / numOdds) * 100;
}

// Mock Data as backup 
const mockGames = [
  {
    home: "Yankees",
    away: "Red Sox",
    date: "2025-09-27T18:05:00Z", // ISO format for consistent date handling
    pitcherHome: "Gerrit Cole",
    pitcherAway: "Chris Sale",
    last10Home: {wins:7, losses:3},
    last10Away: {wins:6, losses:4},
    why: "Mock: Strong bullpen match",
    oddsHome: 1.80, // Decimal odds
    oddsAway: 2.00, // Decimal odds
    evHome: 8,
    evAway: -5
  },
  {
    home: "Dodgers",
    away: "Giants",
    date: "2025-09-27T20:10:00Z",
    pitcherHome: "Clayton Kershaw",
    pitcherAway: "Johnny Cueto",
    last10Home: {wins:8, losses:2},
    last10Away: {wins:5, losses:5},
    why: "Mock: Hot hitting streak",
    oddsHome: 1.70,
    oddsAway: 2.10,
    evHome: 12,
    evAway: -7
  }
];

// --- API FUNCTION: Fetch MLB Schedule (for pitchers) ---
async function fetchMLBSchedule() {
    const today = new Date().toISOString().slice(0, 10);
    const url = `https://statsapi.mlb.com/api/v1/schedule/games/?sportId=1&startDate=${today}&endDate=${today}&hydrate=probablePitcher`;
    try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.dates && data.dates.length > 0) {
            return data.dates[0].games; // Array of games
        }
        return [];
    } catch (e) {
        console.error("MLB Schedule fetch failed.");
        return [];
    }
}

// --- Fetch live OddsAPI data ---
async function fetchOdds() {
  if(apiRemaining <= 0) return null;
  try {
    // Requesting Head-to-Head (Moneyline) market
    const res = await fetch(`https://api.the-odds-api.com/v4/sports/baseball_mlb/odds/?apiKey=${oddsApiKey}&regions=us&markets=h2h`);
    apiRemaining--;
    document.getElementById('apiCount').textContent = apiRemaining;
    const data = await res.json();
    return data;
  } catch(e) {
    console.log("OddsAPI fetch failed, using mock data.");
    return null;
  }
}

// --- RENDER GAME CARD FUNCTION ---
function renderGame(game) {
  // Calculate probability
  const probHome = calculateImpliedProbability(game.oddsHome).toFixed(1);
  const probAway = calculateImpliedProbability(game.oddsAway).toFixed(1);

  const card = document.createElement('div');
  card.className = 'game-card';
  card.innerHTML = `
    <h2>${game.away} @ ${game.home}</h2>
    <div>Date: ${new Date(game.date).toLocaleTimeString()}</div>
    <div class="stats">
      <div class="stat-item">Home Pitcher: <span class="highlight">${game.pitcherHome}</span></div>
      <div class="stat-item">Away Pitcher: <span class="highlight">${game.pitcherAway}</span></div>
      <div class="stat-item">Home Last 10: W${game.last10Home.wins}-L${game.last10Home.losses}</div>
      <div class="stat-item">Away Last 10: W${game.last10Away.wins}-L${game.last10Away.losses}</div>
      <div class="stat-item">EV Home: ${game.evHome}%</div>
      <div class="stat-item">EV Away: ${game.evAway}%</div>
    </div>
    <div class="props">
      <div class="stat-item highlight">Why: ${game.why}</div>
    </div>
    <div class="props">
      <div class="stat-item">
        Odds Home: ${game.oddsHome}
        <span class="prob">(${probHome}%)</span>
      </div>
      <div class="stat-item">
        Odds Away: ${game.oddsAway}
        <span class="prob">(${probAway}%)</span>
      </div>
    </div>
  `;
  gamesContainer.appendChild(card);
}


// --- CALCULATOR FUNCTION ---
function calculateBet() {
  const stake = parseFloat(document.getElementById('stake').value);
  const team = teamSelect.value;
  if(!stake || !team) {
    alert("Enter stake and select team");
    return;
  }
  
  let game = null;
  
  // Try to find the game object based on the currently displayed cards/data
  const allGameData = (gamesContainer.children.length > 0) 
    ? [...gamesContainer.children].map(card => {
        const h2Text = card.querySelector('h2').textContent;
        const homeTeam = h2Text.split(' @ ')[1].trim();
        const awayTeam = h2Text.split(' @ ')[0].trim();
        
        // Extract odds from the displayed text
        const oddsHomeMatch = card.querySelector('.props .stat-item:nth-child(1)').textContent.match(/Odds Home: (\d+\.?\d*)/);
        const oddsAwayMatch = card.querySelector('.props .stat-item:nth-child(2)').textContent.match(/Odds Away: (\d+\.?\d*)/);

        // This assumes the EV placeholder is always 5/-5 if not live calculated
        return {
            home: homeTeam,
            away: awayTeam,
            oddsHome: parseFloat(oddsHomeMatch ? oddsHomeMatch[1] : 0),
            oddsAway: parseFloat(oddsAwayMatch ? oddsAwayMatch[1] : 0),
            evHome: 5, 
            evAway: -5 
        };
    })
    : mockGames; // Fallback to mock data structure

  game = allGameData.find(g => g.home === team || g.away === team);


  if(!game) {
    document.getElementById('calcResult').innerHTML = `Game data for ${team} not found.`;
    return;
  }

  const odds = game.home===team ? game.oddsHome : game.oddsAway;
  const ev = game.home===team ? game.evHome : game.evAway;
  const payout = (stake * odds).toFixed(2);

  document.getElementById('calcResult').innerHTML = `
    <strong>Potential Payout:</strong> $${payout} <br>
    <strong>EV:</strong> ${ev}%
  `;
}


// --- MAIN INITIALIZATION FUNCTION ---
async function init() {
  const oddsData = await fetchOdds();
  const mlbSchedule = await fetchMLBSchedule();
  
  const displayGames = [];
  let availableTeams = new Set();
  
  if (oddsData && oddsData.length > 0) {
    const topGames = oddsData.slice(0, 5); // Use top 5 games
    
    topGames.forEach(oddsGame => {
      // Find the corresponding game in the MLB schedule by team names
      const mlbGame = mlbSchedule.find(
        g => g.teams.home.team.name === oddsGame.home_team || g.teams.away.team.name === oddsGame.away_team
      );

      // Default odds to the first bookmaker for simplicity
      const bookmaker = oddsGame.bookmakers[0];
      const market = bookmaker?.markets.find(m => m.key === 'h2h');
      
      const homeOutcome = market?.outcomes.find(o => o.name === oddsGame.home_team);
      const awayOutcome = market?.outcomes.find(o => o.name === oddsGame.away_team);

      // Construct the final game data object
      const gameData = {
        home: oddsGame.home_team,
        away: oddsGame.away_team,
        date: oddsGame.commence_time,
        
        // Pitcher Integration
        pitcherHome: mlbGame?.teams.home.probablePitcher?.fullName || "TBD",
        pitcherAway: mlbGame?.teams.away.probablePitcher?.fullName || "TBD",
        
        // Placeholders (Needs detailed API work to be real)
        last10Home: {wins: 5, losses: 5},
        last10Away: {wins: 5, losses: 5},
        why: "Analysis requires Pitcher Splits vs. Team Stats.",
        evHome: 5,
        evAway: -5,
        
        // **CRITICAL FIX**: Using 'price' for Moneyline (h2h) odds
        oddsHome: homeOutcome?.price || 0, 
        oddsAway: awayOutcome?.price || 0,
      };
      
      displayGames.push(gameData);
      availableTeams.add(gameData.home);
      availableTeams.add(gameData.away);
    });
  } 
  
  // Fallback to mock data if no live data is found
  if (displayGames.length === 0) {
    mockGames.forEach(renderGame);
    mockGames.forEach(g => {
        availableTeams.add(g.home);
        availableTeams.add(g.away);
    });
  } else {
    // Render live/merged data
    displayGames.forEach(renderGame);
  }
  
  // Populate the team select dropdown with available teams
  teamSelect.innerHTML = '<option value="">Select team</option>';
  availableTeams.forEach(team => {
      const option = document.createElement('option');
      option.value = team;
      option.textContent = team;
      teamSelect.appendChild(option);
  });
}

init();
</script>
</body>
</html>
